{% extends 'global/Page.html' %}

{% block title %}
<div class="d-flex justify-content-center" style="margin-top: -50px">
    <h2 style="margin-bottom:20px">MATH TASK</h2>
</div>
{% endblock %}

{% block content %}

<div class="row" style="padding-left:150px; padding-right: 150px; font-size: larger">
    <div class="col-8">
        <table class="table text-center borderless no-shading table-fixed-height">
            <colgroup>
                <col style="width: 55%;">  <!-- First column: 2/3 of table width -->
                <col style="width: 10%;">    <!-- Second column: Small width for "=" -->
                <col style="width: 35%;">  <!-- Third column: Remaining space -->
            </colgroup>
            <tr>
                <td></td>
                <td></td>
                <td>Partial Answers</td>
            </tr>
            <tr>
                <td id="eq_1">loading...</td>
                <td>=</td>
                <td><input id="sol_1" type="number" pattern="[0-9]*" maxlength="3" class="form-control answer-box editable" onclick="selectSol(this)" onblur="deselectSol(this)" oninput="inputChanged(this)"></td>
            </tr>
            <tr>
                <td id="eq_2">loading...</td>
                <td>=</td>
                <td><input id="sol_2" type="number" pattern="[0-9]*" maxlength="3" class="form-control answer-box editable" onclick="selectSol(this)" onblur="deselectSol(this)" oninput="inputChanged(this)"></td>
            </tr>
            <tr>
                <td id="eq_3">loading...</td>
                <td>=</td>
                <td><input id="sol_3" type="number" pattern="[0-9]*" maxlength="3" class="form-control answer-box editable" onclick="selectSol(this)" onblur="deselectSol(this)" oninput="inputChanged(this)"></td>
            </tr>
        </table>
    </div>
    <div class="col-1">
    </div>
    <div class="col-3">
        <table class="table text-center borderless no-shading table-fixed-height">
            <tr>
                <td>Final Answer</td>
            </tr>
            <tr>
                <td><input id="fin_sol_a" type="number" pattern="[0-9]*" maxlength="3" class="form-control answer-box readonly" placeholder="" readonly></td>
            </tr>
            <tr>
                <td><input id="fin_sol_own" type="number" pattern="[0-9]*" maxlength="3" class="form-control answer-box editable" placeholder="" onclick="selectFinSol()" oninput="finalInputChanged(this)"></td>
            </tr>
            <tr>
                <td><input id="fin_sol_b" type="number" pattern="[0-9]*" maxlength="3" class="form-control answer-box readonly" placeholder="" readonly></td>
            </tr>
        </table>
    </div>
</div>

<!-- NEXT BUTTON -->
<div>
    <div class="d-flex justify-content-center" style="display:none">
        <button class="btn-primary btn-lg" id="nextbtn" style="display:none">Next</button>
    </div>
</div>

<!-- Logging fields -->
<input type="hidden" name="load_time" id="load_time" value=""/>
{{ formfield_errors 'load_time' }}
<input type="hidden" name="action_log" id="action_log" value=""/>
{{ formfield_errors 'action_log' }}



{% endblock %}

{% block style %}

<style>
    .answer-box {text-align: center; font-weight: bold; font-size: large }
    .editable { cursor: pointer; background-color: white; }
    .readonly { cursor: not-allowed; }
    .highlighted { background-color: {{color}} !important; }

    /* Remove all table borders */
    .table.borderless td, .table.borderless th {
        border: none !important;
        background: transparent !important;
    }

    /* Remove Bootstrap's row striping (shading for even rows) */
    .table.no-shading tbody tr:nth-of-type(even),
    .table.no-shading tbody tr:nth-of-type(odd) {
        background-color: transparent !important;
    }

    .table-fixed-height td {
        height: 50px; /* Adjust this value as needed */
        vertical-align: middle; /* Ensures text stays centered */
    }

    /* Borders */
    .lightcoral-b {
        border: 4px solid lightcoral !important;
    }
    .lightblue-b {
        border: 4px solid lightblue !important;
    }
    .lightgreen-b {
        border: 4px solid lightgreen !important;
    }

    /* Backgrounds */
    .lightcoral {
        background-color: lightcoral !important;
    }
    .lightblue {
        background-color: lightblue !important;
    }
    .lightgreen {
        background-color: lightgreen !important;
    }


</style>

{% endblock %}

{% block scripts %}

<script>
    function generateEquations(level, difficulty) {
        // Define digit range based on difficulty
        let digitRange = difficulty === "Hard" ? 6 : 3;

        // Initialize equations as strings
        let equations = [
            "100", // Equation 1
            "100", // Equation 2
            "100"  // Equation 3
        ];

        // Create an array of random digits with length (level + 3)
        let digits = Array.from({ length: level + 3 }, () => Math.floor(Math.random() * digitRange) + 1);

        // Cycle through equations and distribute digits
        let i = 0;
        while (digits.length > 0) {
            let digit = digits.shift(); // Remove one digit from the array
            if (/\d{2}$/.test(equations[i])) { // If the equation ends with two digits
                equations[i] += " + " + digit;
            } else {
                equations[i] += digit; // Append the digit directly
            }
            i = (i + 1) % 3; // Cycle through equations
        }

        // Calculate solutions by evaluating the string equations
        let solutions = equations.map(eq => eval(eq)); // Safely interpret and compute the equation

        // Compute final solution as the sum of all individual solutions
        let finalSolution = solutions.reduce((acc, val) => acc + val, 0);

        return {
            equations: equations,
            solutions: solutions,
            finalSolution: finalSolution
        };
    }
</script>

<script>
    const duration = 5*60;
    let equationObject = [];
    let level = {{level}};
    let difficulty = "{{difficulty}}";

    function updateEquations() {
         if ('{{color}}' === 'lightcoral') {
            equationObject = generateEquations(level, "Optimal");
            // Send the generated equations to all players
            liveSend({
                "info_type": "Equations",
                "equations": equationObject.equations,
                "solutions": equationObject.solutions,
                "finalSolution": equationObject.finalSolution
            });

            document.getElementById("eq_1").textContent = equationObject.equations[0];
            document.getElementById("eq_2").textContent = equationObject.equations[1];
            document.getElementById("eq_3").textContent = equationObject.equations[2];
        }
    }

    /// Start Time Log
    document.addEventListener("DOMContentLoaded", function() {
        if ('{{color}}' === 'lightcoral') {
            document.getElementById("fin_sol_own").classList.add("lightcoral-b");
            document.getElementById("fin_sol_a").classList.add("lightblue-b");
            document.getElementById("fin_sol_b").classList.add("lightgreen-b");

            setTimeout(() => {
                updateEquations();
            }, 1000);

        } else if ('{{color}}' === 'lightgreen') {
            document.getElementById("fin_sol_own").classList.add("lightgreen-b");
            document.getElementById("fin_sol_a").classList.add("lightblue-b");
            document.getElementById("fin_sol_b").classList.add("lightcoral-b");
        } else if ('{{color}}' === 'lightblue') {
            document.getElementById("fin_sol_own").classList.add("lightblue-b");
            document.getElementById("fin_sol_a").classList.add("lightgreen-b");
            document.getElementById("fin_sol_b").classList.add("lightcoral-b");
        }

        document.getElementById("load_time").value = Date.now();


        setTimeout(() => {
            document.getElementById("nextbtn").click();
        }, duration * 1000);

        setInterval(updateEquations, 28 * 1000);
    });

    function selectSol(element) {
        liveSend({"info_type": "selected", "player": "{{color}}", "selected": element.id});
    }

    function selectFinSol(element) {
        liveSend({"info_type": "selected", "player": "{{color}}", "selected": "final"});
    }

    function deselectSol(element) {
        liveSend({"info_type": "deselect", "player": "{{color}}", "deselected": element.id});
    }

    function inputChanged(element) {
        liveSend({"info_type": "input_changed", "player": "{{color}}", "selected": element.id, "content": element.value});
    }

    function finalInputChanged(element) {
        liveSend({"info_type": "final_input_changed", "player": "{{color}}", "selected": "final", "content": element.value});
    }

</script>

<script>
    function liveRecv(data) {
        if (data.info_type === "Equations") {
            document.getElementById("eq_1").innerText = data.equations[0];
            document.getElementById("eq_2").innerText = data.equations[1];
            document.getElementById("eq_3").innerText = data.equations[2];

            let solutions = data.solutions;
            let final_solution = data.finalSolution;
        }

        if (data.info_type === "selected") {
            // Remove highlight from the player's previous selection
            if (data.previous && data.previous.length > 0) {
                data.previous.forEach(prevId => {
                    let prevElement = document.getElementById(prevId);
                    if (prevElement) {
                        prevElement.classList.remove(data.player);
                    }
                });
            }
            document.getElementById(data.selected).classList.add(data.player);

            if ("{{color}}" == data.player) {
                document.getElementById(data.field).classList.remove("readonly");
                document.getElementById(data.selected).classList.add("editable");
            } else {
                document.getElementById(data.selected).classList.remove("editable");
                document.getElementById(data.selected).classList.add("readonly");
            }
        }

        else if (data.info_type === "deselected") {
            document.getElementById(data.field).classList.remove(data.player);

            document.getElementById(data.field).classList.remove("readonly");
            document.getElementById(data.field).classList.add("editable");
        }

        else if (data.info_type === "input_changed") {
            document.getElementById(data.selected).value = data.content;
        }

        else if (data.info_type === "final_input_changed") {
            if ("{{color}}" !== data.player) {
                if (data.player === "lightcoral") {
                    document.querySelector(".lightcoral-b").value = data.content;
                } else if (data.player === "lightblue") {
                    document.querySelector(".lightblue-b").value = data.content;
                } else if (data.player === "lightgreen") {
                    document.querySelector(".lightgreen-b").value = data.content;
                }
            }
        }
    }


</script>
{% endblock %}

